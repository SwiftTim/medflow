<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Billing Details</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
  <div class="container mt-5">
    <h3 id="invoiceTitle">Process Payment</h3>
    <form id="billingForm">
      <div class="form-group">
        <label>Amount</label>
        <input type="text" class="form-control" id="amountInput" name="amount" readonly>
      </div>

      <div class="form-group">
        <label>Mode of Payment</label>
        <select class="form-control" id="paymentMode" required>
          <option value="">Select</option>
          <option value="cash">Cash</option>
          <option value="mpesa">M-Pesa</option>
        </select>
      </div>

      <div class="form-group d-none" id="mpesaSection">
        <label>M-Pesa Phone Number</label>
        <div class="input-group">
          <input type="text" class="form-control" id="mpesaPhone" placeholder="e.g. 0712345678">
          <div class="input-group-append">
            <button type="button" class="btn btn-success" id="stkPushBtn">Prompt Payment</button>
          </div>
        </div>
        <small id="stkStatus" class="text-muted"></small>
      </div>

      <button type="submit" class="btn btn-primary">Submit Payment</button>
    </form>
  </div>

  <!-- Hidden printable receipt -->
  <div id="receipt" class="d-none p-4" style="max-width: 500px; margin: auto; font-family: monospace; border: 1px solid #ccc;">
    <h5 class="text-center">St. Josephs Hospital</h5>
    <p class="text-center mb-1">VAT INVOICE</p>
    <p>Invoice No: <span id="printInvoiceNo"></span></p>
    <p>Date: <span id="printDate"></span></p>
    <p>Amount: KES <span id="printAmount"></span></p>
    <p>VAT (16%): KES <span id="printVAT"></span></p>
    <p><strong>Total Paid: KES <span id="printTotal"></span></strong></p>
    <p>Mode: <span id="printMode"></span></p>
    <hr>
    <p class="text-center">Thank you!</p>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js';
    import { getDatabase, ref, get, update, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCLzofD9xL1agw4Vc6ZzWotzSnkxv-r_-E",
      authDomain: "medflow-53221.firebaseapp.com",
      databaseURL: "https://medflow-53221-default-rtdb.firebaseio.com",
      projectId: "medflow-53221",
      storageBucket: "medflow-53221.appspot.com",
      messagingSenderId: "644922689822",
      appId: "1:644922689822:web:531fb3d8cfc8f95f96a10f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let billingData = {};
    const params = new URLSearchParams(window.location.search);
    const patientId = params.get("patientId");
    const invoiceId = params.get("invoiceId");

    document.addEventListener("DOMContentLoaded", async () => {
      if (!patientId || !invoiceId) return;

      const invoiceRef = ref(db, `patient_profiles/${patientId}/billing/${invoiceId}`);
      const snapshot = await get(invoiceRef);
      if (snapshot.exists()) {
        billingData = snapshot.val();
        document.getElementById("amountInput").value = parseFloat(billingData.amount).toFixed(2);
        document.getElementById("invoiceTitle").textContent = `Process Payment for Invoice #${billingData.invoiceNo}`;
      } else {
        alert("Billing record not found.");
      }

      document.getElementById("paymentMode").addEventListener("change", (e) => {
        const mode = e.target.value;
        document.getElementById("mpesaSection").classList.toggle("d-none", mode !== "mpesa");
      });

      document.getElementById("stkPushBtn").addEventListener("click", async () => {
        const phone = document.getElementById("mpesaPhone").value.trim();
        const amount = parseInt(billingData.amount);
        const status = document.getElementById("stkStatus");
        status.textContent = "Sending prompt...";

        const response = await fetch("https://sandbox.safaricom.co.ke/mpesa/stkpush/v1/processrequest", {
          method: "POST",
          headers: {
            "Authorization": "Bearer YOUR_ACCESS_TOKEN",
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            BusinessShortCode: "174379",
            Password: "bfb279f9aa9bdbcf158e97dd71a467cd2e0c893059b10f78e6b72ada1ed2c919",
            Timestamp: "REPLACE_WITH_TIMESTAMP",
            TransactionType: "CustomerPayBillOnline",
            Amount: amount,
            PartyA: phone.replace(/^0/, '254745799633'),
            PartyB: "174379",
            PhoneNumber: phone.replace(/^0/, '254745799633'),
            CallBackURL: "https://yourdomain.com/callback",
            AccountReference: billingData.invoiceNo,
            TransactionDesc: "Payment for invoice"
          })
        });

        const resData = await response.json();
        if (resData.ResponseCode === "0") {
          status.textContent = `STK Push sent to ${phone}. Awaiting PIN entry.`;
        } else {
          status.textContent = `Error: ${resData.errorMessage || "Failed to initiate STK push."}`;
        }
      });

      document.getElementById("billingForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const mode = document.getElementById("paymentMode").value;
        if (!mode) return alert("Please select a mode of payment.");

        const invoiceRef = ref(db, `patient_profiles/${patientId}/billing/${invoiceId}`);
        await update(invoiceRef, {
          status: "processed",
          paymentMode: mode,
          processedAt: serverTimestamp()
        });

        if (mode === "cash") {
          const amount = parseFloat(billingData.amount);
          const vat = amount * 0.16;
          const total = amount + vat;

          document.getElementById("printInvoiceNo").textContent = billingData.invoiceNo;
          document.getElementById("printDate").textContent = new Date().toLocaleString();
          document.getElementById("printAmount").textContent = amount.toFixed(2);
          document.getElementById("printVAT").textContent = vat.toFixed(2);
          document.getElementById("printTotal").textContent = total.toFixed(2);
          document.getElementById("printMode").textContent = mode;

          const receipt = document.getElementById("receipt");
          receipt.classList.remove("d-none");
          window.print();
        } else {
          alert("M-Pesa payment processing initiated.");
        }
      });
    });
  </script>
</body>
</html>
